
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Modular Reduction Projection Research Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --main-color: #0f4c75;
            --accent-color: #3282b8;
            --text-color: #bbe1fa;
            --highlight-color: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            line-height: 1.6;
        }

        /* Header and Navigation */
        .site-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }

        .site-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .site-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-style: italic;
        }

        /* Tab Navigation */
        .tab-nav {
            background: #2c3e50;
            padding: 0;
            display: flex;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-button {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #bbe1fa;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab-button.active {
            background: rgba(255,255,255,0.15);
            border-bottom-color: var(--highlight-color);
            color: var(--highlight-color);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Portal Tab Styles */
        .portal-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .visualization-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .viz-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .viz-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .viz-meta {
            font-size: 1rem;
            color: #7f8c8d;
        }

        #vizContainer {
            width: 100%;
            aspect-ratio: 1;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            touch-action: none;
            cursor: grab;
        }

        #vizContainer:active {
            cursor: grabbing;
        }

        #vizSVG {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls-panel {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .controls-panel h2 {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }

        .control-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #ecf0f1;
        }

        .control-section:last-child {
            border-bottom: none;
        }

        .control-section h3 {
            font-size: 1.1rem;
            color: #34495e;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .control-row {
            margin-bottom: 1rem;
        }

        .control-label {
            display: block;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="number"],
        select,
        input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .value-display {
            display: inline-block;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #667eea;
            min-width: 60px;
            text-align: right;
        }

        button {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 0.5rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            transform: none;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .button-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.4rem;
            margin-top: 0.8rem;
        }

        .preset-btn {
            padding: 0.5rem;
            font-size: 0.85rem;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #667eea30;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 0.3rem;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .badge-prime {
            background: #2ecc71;
            color: white;
        }

        .badge-composite {
            background: #e74c3c;
            color: white;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.6rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .info-text {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 0.5rem;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
            border: 1px solid #667eea;
            font-family: 'Courier New', monospace;
            max-width: 250px;
        }

        .recording-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
            display: none;
            animation: pulse 1.5s infinite;
            z-index: 2000;
        }

        .recording-badge.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Theory Tab Styles */
        .theory-container {
            max-width: 900px;
            margin: 2rem auto;
            background: #ffffff;
            padding: 3rem 4rem;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
            border: 1px solid #8b7355;
            font-family: 'Garamond', 'Georgia', 'Times New Roman', serif;
            color: #2c2416;
            line-height: 1.8;
        }

        .theory-container h1 {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 3px double #8b7355;
            padding-bottom: 1rem;
        }

        .theory-container h2 {
            font-size: 1.8rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            font-weight: normal;
            border-left: 5px solid #8b7355;
            padding-left: 1rem;
        }

        .theory-container h3 {
            font-size: 1.4rem;
            margin-top: 2rem;
            margin-bottom: 0.8rem;
            font-weight: normal;
            font-style: italic;
        }

        .theory-container p {
            text-align: justify;
            margin-bottom: 1rem;
            text-indent: 2em;
        }

        .theory-container .no-indent {
            text-indent: 0;
        }

        .theorem, .definition, .proposition {
            background: #faf8f3;
            border-left: 4px solid #8b7355;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-style: italic;
        }

        .theorem::before {
            content: "Theorem. ";
            font-weight: bold;
            font-style: normal;
        }

        .definition::before {
            content: "Definition. ";
            font-weight: bold;
            font-style: normal;
        }

        .proposition::before {
            content: "Proposition. ";
            font-weight: bold;
            font-style: normal;
        }

        .divider {
            text-align: center;
            font-size: 1.5rem;
            color: #8b7355;
            margin: 2rem 0;
        }

        .equation {
            text-align: center;
            margin: 1.5rem 0;
            font-size: 1.1rem;
        }

        .list-roman {
            list-style-type: upper-roman;
            margin-left: 3rem;
            margin-bottom: 1rem;
        }

        blockquote {
            font-style: italic;
            margin: 1.5rem 2rem;
            padding-left: 1.5rem;
            border-left: 3px solid #8b7355;
            color: #5c4a3a;
        }

        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        @media (max-width: 1024px) {
            .portal-container {
                grid-template-columns: 1fr;
            }

            .controls-panel {
                max-height: none;
            }

            .site-title {
                font-size: 1.5rem;
            }

            .theory-container {
                padding: 2rem;
            }
        }

        @media (max-width: 640px) {
            .portal-container {
                padding: 0 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tab-button {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="recording-badge" id="recordingBadge">‚óè RECORDING</div>

    <header class="site-header">
        <div class="header-content">
            <h1 class="site-title">Modular Reduction Projection Research Portal</h1>
            <p class="site-subtitle">Interactive Visualization of Number-Theoretic Structures in ‚Ñ§/M‚Ñ§</p>
        </div>
    </header>

    <nav class="tab-nav">
        <button class="tab-button active" onclick="switchTab('portal')">üî¨ Interactive Portal</button>
        <button class="tab-button" onclick="switchTab('theory')">üìñ Mathematical Theory</button>
        <button class="tab-button" onclick="switchTab('about')">‚ÑπÔ∏è About</button>
    </nav>

    <!-- PORTAL TAB -->
    <div id="portal-tab" class="tab-content active">
        <div class="portal-container">
            <section class="visualization-section">
                <div class="viz-header">
                    <h2 class="viz-title" id="vizTitle">Modular Space: M = 42</h2>
                    <p class="viz-meta" id="vizMeta">Prime Factorization: 2 √ó 3 √ó 7</p>
                </div>

                <div id="vizContainer">
                    <svg id="vizSVG" viewBox="-500 -500 1000 1000" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <g id="vizGroup"></g>
                    </svg>
                </div>

                <div class="tooltip" id="tooltip"></div>
            </section>

            <aside class="controls-panel">
                <h2>Research Controls</h2>

                <div class="control-section">
                    <h3>Animation Controls</h3>
                    <div class="button-grid">
                        <button id="playBtn" onclick="startAnimation()">‚ñ∂ Play</button>
                        <button id="stopBtn" onclick="stopAnimation()" disabled>‚è∏ Stop</button>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Speed: <span class="value-display" id="speedVal">500</span> ms</label>
                        <input type="range" id="speedSlider" min="50" max="2000" step="50" value="500">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="loopCheck" checked>
                        <label for="loopCheck">Loop Animation</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="recordCheck">
                        <label for="recordCheck">Record Frames</label>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Modulus Configuration</h3>
                    <div class="control-row">
                        <label class="control-label">M = <span class="value-display" id="modVal">42</span></label>
                        <input type="range" id="modSlider" min="2" max="5000" value="42">
                    </div>
                    <div class="control-row">
                        <input type="number" id="modInput" min="2" max="10000" value="42" placeholder="Enter M">
                    </div>
                    <div class="preset-grid">
                        <button class="preset-btn" onclick="setM(12)">12</button>
                        <button class="preset-btn" onclick="setM(30)">30</button>
                        <button class="preset-btn" onclick="setM(60)">60</button>
                        <button class="preset-btn" onclick="setM(210)">210</button>
                        <button class="preset-btn" onclick="setM(420)">420</button>
                        <button class="preset-btn" onclick="setM(2310)">2310</button>
                        <button class="preset-btn" onclick="setM(17)">17‚òÖ</button>
                        <button class="preset-btn" onclick="setM(101)">101‚òÖ</button>
                        <button class="preset-btn" onclick="setM(1024)">2¬π‚Å∞</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>View Controls</h3>
                    <div class="control-row">
                        <label class="control-label">Zoom: <span class="value-display" id="zoomVal">1.00</span>√ó</label>
                        <input type="range" id="zoomSlider" min="10" max="500" step="10" value="100">
                    </div>
                    <button onclick="resetView()">‚Üª Reset View</button>
                </div>

                <div class="control-section">
                    <h3>Statistical Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Modulus</div>
                            <div class="stat-value" id="statM">42</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">œÜ(M)</div>
                            <div class="stat-value" id="statPhi">12</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Coprime</div>
                            <div class="stat-value" id="statCoprime">12</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Non-coprime</div>
                            <div class="stat-value" id="statNonCoprime">30</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Channels</div>
                            <div class="stat-value" id="statChannels">8</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Density</div>
                            <div class="stat-value" id="statDensity">28.6%</div>
                        </div>
                        <div class="stat-card" style="grid-column: 1 / -1;">
                            <div class="stat-label">Classification</div>
                            <div class="stat-value">
                                <span id="statClass">Composite</span>
                                <span id="statBadge" class="badge badge-composite">œâ(M)=3</span>
                            </div>
                        </div>
                    </div>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.8rem; font-size: 1rem; color: #555;">Prime Constellations</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Twin (2)</div>
                            <div class="stat-value" id="statTwin">3</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Cousin (4)</div>
                            <div class="stat-value" id="statCousin">2</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sexy (6)</div>
                            <div class="stat-value" id="statSexy">3</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Gap 8</div>
                            <div class="stat-value" id="statGap8">1</div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Visual Appearance</h3>
                    <div class="control-row">
                        <label class="control-label">Color Scheme</label>
                        <select id="colorScheme">
                            <option value="type" selected>Coprime vs Non-coprime</option>
                            <option value="spf">Smallest Prime Factor</option>
                            <option value="lpf">Largest Prime Factor</option>
                            <option value="gcd">GCD Value</option>
                            <option value="depth">Channel Depth</option>
                            <option value="rainbow">Rainbow Spectrum</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Point Size: <span class="value-display" id="pointSizeVal">3.0</span></label>
                        <input type="range" id="pointSizeSlider" min="1" max="10" step="0.5" value="3">
                    </div>
                    <div class="control-row">
                        <label class="control-label">Line Opacity: <span class="value-display" id="opacityVal">100</span>%</label>
                        <input type="range" id="opacitySlider" min="0" max="100" step="5" value="100">
                    </div>
                </div>

                <div class="control-section">
                    <h3>Geometric Parameters</h3>
                    <div class="control-row">
                        <label class="control-label">Ring Spacing: <span class="value-display" id="spacingVal">1.00</span></label>
                        <input type="range" id="spacingSlider" min="0" max="200" step="5" value="100">
                    </div>
                    <div class="control-row">
                        <label class="control-label">Minimum Ring (M'): <span class="value-display" id="minRingVal">1</span></label>
                        <input type="range" id="minRingSlider" min="1" max="100" step="1" value="1">
                    </div>
                    <div class="control-row">
                        <label class="control-label">Rotation Angle: <span class="value-display" id="rotationVal">0</span>¬∞</label>
                        <input type="range" id="rotationSlider" min="0" max="360" step="1" value="0">
                    </div>
                </div>

                <div class="control-section">
                    <h3>Display Options</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showProjections" checked>
                        <label for="showProjections">Projection Lines</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showRings" checked>
                        <label for="showRings">Channel Rings</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showInnerRings" checked>
                        <label for="showInnerRings">Inner Ring Points</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="colorInner">
                        <label for="colorInner">Color Inner Points</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showSymmetry">
                        <label for="showSymmetry">Show Symmetry Axes</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="highlightPrimes">
                        <label for="highlightPrimes">Highlight Prime Residues</label>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Constellation Highlight</label>
                        <select id="gapSelect">
                            <option value="none" selected>None</option>
                            <option value="2">Twin (Gap 2)</option>
                            <option value="4">Cousin (Gap 4)</option>
                            <option value="6">Sexy (Gap 6)</option>
                            <option value="8">Gap 8</option>
                            <option value="10">Gap 10</option>
                            <option value="12">Gap 12</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Filter Residues</label>
                        <select id="filterType">
                            <option value="none" selected>All Residues</option>
                            <option value="prime">r is Prime</option>
                            <option value="square">r is Perfect Square</option>
                            <option value="fibonacci">r in Fibonacci Sequence</option>
                            <option value="power2">r is Power of 2</option>
                            <option value="quadratic">Quadratic Residues</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Advanced Analysis</h3>
                    <button onclick="analyzePattern()">üî¨ Pattern Analysis</button>
                    <button onclick="compareModuli()">üìä Compare Moduli</button>
                    <button onclick="findInteresting()">‚ú® Find Interesting M</button>
                    <button onclick="showTheorems()">üìñ Mathematical Theorems</button>
                    <div id="analysisResults" style="margin-top: 1rem; padding: 0.8rem; background: #f0f0f0; border-radius: 6px; display: none; max-height: 300px; overflow-y: auto; font-size: 0.85rem; color: #333;"></div>
                </div>

                <div class="control-section">
                    <h3>Number Generators</h3>
                    <button onclick="generatePrimorial()">Generate Primorial</button>
                    <button onclick="generateFactorial()">Generate Factorial</button>
                    <button onclick="generateHighlyComposite()">Highly Composite</button>
                </div>

                <div class="control-section">
                    <h3>Data Export</h3>
                    <div class="control-row">
                        <label class="control-label">Export Resolution (px)</label>
                        <input type="number" id="exportRes" value="3000" min="1000" max="8000" step="500">
                    </div>
                    <div class="button-grid-3">
                        <button onclick="exportPNG()">PNG</button>
                        <button onclick="exportCSV()">CSV</button>
                        <button onclick="exportJSON()">JSON</button>
                    </div>
                    <button onclick="exportFrames()">Export Frames (PNG)</button>
                    <button onclick="exportGIF()">Export Animation (GIF)</button>
                    <button onclick="exportLaTeX()">Export LaTeX Code</button>
                </div>
            </aside>
        </div>
    </div>

    <!-- THEORY TAB -->
    <div id="theory-tab" class="tab-content">
        <div class="theory-container">
            <div style="text-align: center; font-size: 2rem; color: #8b7355; margin-bottom: 1rem;">‚ù¶</div>
            
            <h1>Modular Reduction Projection</h1>
            
            <p class="subtitle no-indent" style="text-align: center; font-style: italic; font-size: 1.1rem; color: #5c4a3a; margin-bottom: 2rem;">
                A Geometric Visualization of Residue Class Structures in $\mathbb{Z}/M\mathbb{Z}$
            </p>

            <div class="divider">‚ÅÇ</div>

            <h2>I. Mathematical Foundations</h2>

            <h3>¬ß1. The Ring of Integers Modulo M</h3>

            <div class="definition">
                Let $M \in \mathbb{N}$, $M \geq 2$. The ring of integers modulo $M$ is $\mathbb{Z}/M\mathbb{Z} = \{0, 1, 2, \ldots, M-1\}$ with addition and multiplication modulo $M$.
            </div>

            <p>Each element $r \in \mathbb{Z}/M\mathbb{Z}$ represents an equivalence class of integers congruent to $r$ modulo $M$. The structure of this ring is fundamental to algebraic number theory, cryptography, and Diophantine equations.</p>

            <h3>¬ß2. Euler's Totient Function</h3>

            <div class="definition">
                Euler's totient function $\varphi(M)$ counts integers $r \in \{1, 2, \ldots, M\}$ where $\gcd(r, M) = 1$. These form the group of units $(\mathbb{Z}/M\mathbb{Z})^*$.
            </div>

            <div class="theorem">
                For $M = p_1^{e_1} p_2^{e_2} \cdots p_k^{e_k}$:
                $$\varphi(M) = M \prod_{i=1}^{k} \left(1 - \frac{1}{p_i}\right)$$
            </div>

            <h3>¬ß3. Geometric Representation</h3>

            <p>We map each residue $r \in \{0, 1, \ldots, M-1\}$ to the unit circle via:</p>

            <div class="equation">
                $$z_r = e^{2\pi i r / M}$$
            </div>

            <p class="no-indent"><strong>Important:</strong> This places $r=0$ at angle $0$ (the positive real axis, or 3 o'clock position), and subsequent residues proceed counterclockwise. This matches the standard unit circle convention in mathematics.</p>

            <div class="definition">
                For residue $r$ with $\gcd(r, M) = d$, define $r' = r/d$ and $M' = M/d$. We call $M'$ the <em>reduction channel</em> of $r$.
            </div>

            <h2>II. Key Properties</h2>

            <div class="theorem">
                The number of reduction channels equals $\tau(M)$, the divisor function.
            </div>

            <div class="proposition">
                Coprime residues ($\gcd(r,M)=1$) appear on the outer circle. Non-coprime residues project to inner circles corresponding to their channels $M' \mid M$.
            </div>

            <h3>Prime Constellations</h3>

            <p>The visualization reveals patterns in coprime pairs $(r_1, r_2)$ with fixed gaps $k = r_2 - r_1$:</p>

            <ul class="list-roman">
                <li><strong>Twin Primes</strong> ($k=2$): Adjacent coprime residues</li>
                <li><strong>Cousin Primes</strong> ($k=4$): Gap-4 coprime pairs</li>
                <li><strong>Sexy Primes</strong> ($k=6$): Gap-6 coprime pairs</li>
            </ul>

            <h2>III. The Chinese Remainder Theorem</h2>

            <p>For coprime $m_1, m_2$ with $M = m_1 m_2$, the isomorphism:</p>

            <div class="equation">
                $$\mathbb{Z}/M\mathbb{Z} \cong \mathbb{Z}/m_1\mathbb{Z} \times \mathbb{Z}/m_2\mathbb{Z}$$
            </div>

            <p class="no-indent">manifests geometrically as factorization of the circular structure.</p>

            <h2>IV. Applications</h2>

            <p>This visualization serves multiple purposes in mathematical research and education:</p>

            <ul class="list-roman">
                <li>Visual intuition for abstract algebraic concepts</li>
                <li>Pattern discovery before formal proof</li>
                <li>Connection between number theory and geometry</li>
                <li>Computational experimentation platform</li>
            </ul>

            <blockquote>
                "The purpose of computation is insight, not numbers." ‚Äî Richard Hamming
            </blockquote>

            <h2>V. Special Cases</h2>

            <div class="proposition">
                For prime $M=p$: All $p-1$ non-zero residues are coprime, yielding a uniform circle.
            </div>

            <p>Primorial numbers $M = 2 \cdot 3 \cdot 5 \cdot 7 \cdots$ exhibit maximal channel richness, while highly composite numbers provide intricate symmetry patterns with numerous divisors.</p>

            <div class="divider">‚ÅÇ</div>

            <p class="no-indent" style="text-align: center; font-style: italic; margin-top: 2rem;">
                For interactive exploration, return to the Portal tab above.
            </p>
        </div>
    </div>

    <!-- ABOUT TAB -->
    <div id="about-tab" class="tab-content">
        <div class="theory-container">
            <h1>About This Research Tool</h1>

            <div class="divider">‚ÅÇ</div>

            <h2>Overview</h2>

            <p>The Modular Reduction Projection Research Portal is a comprehensive web-based platform for exploring number-theoretic structures through geometric visualization. It combines rigorous mathematical foundations with interactive exploration capabilities.</p>

            <h2>Features</h2>

            <h3>Visualization</h3>
            <ul>
                <li>Real-time SVG rendering with smooth animations</li>
                <li>Touch-optimized controls (pinch zoom, pan)</li>
                <li>6 different color schemes</li>
                <li>Configurable rotation and symmetry display</li>
                <li>Prime residue highlighting</li>
            </ul>

            <h3>Analysis Tools</h3>
            <ul>
                <li>Automatic pattern detection and analysis</li>
                <li>Statistical summaries and comparisons</li>
                <li>Prime constellation identification</li>
                <li>Mathematical theorem reference</li>
            </ul>

            <h3>Export Capabilities</h3>
            <ul>
                <li>High-resolution PNG images (up to 8000√ó8000px)</li>
                <li>Animated GIF sequences</li>
                <li>CSV and JSON data formats</li>
                <li>LaTeX document generation</li>
                <li>Frame-by-frame export for video creation</li>
            </ul>

            <h2>Mathematical Content</h2>

            <p>This tool implements and visualizes:</p>
            <ul>
                <li>Euler's totient function œÜ(M)</li>
                <li>Greatest common divisor calculations</li>
                <li>Prime factorization</li>
                <li>Reduction channel decomposition</li>
                <li>Chinese Remainder Theorem structure</li>
                <li>Prime constellation patterns</li>
            </ul>

            <h2>Educational Applications</h2>

            <p>Suitable for:</p>
            <ul>
                <li>Undergraduate number theory courses</li>
                <li>Abstract algebra visualization</li>
                <li>Cryptography foundations</li>
                <li>Mathematical research and exploration</li>
                <li>Computational mathematics demonstrations</li>
            </ul>

            <h2>Technical Details</h2>

            <p class="no-indent"><strong>Browser Requirements:</strong> Modern browser with JavaScript and SVG support</p>
            <p class="no-indent"><strong>Performance:</strong> Optimized for M up to 10,000</p>
            <p class="no-indent"><strong>External Libraries:</strong> GIF.js (animation export), MathJax (equation rendering)</p>

            <h2>Usage Tips</h2>

            <ol>
                <li>Start with small moduli (M < 100) to understand patterns</li>
                <li>Try primorials (30, 210, 2310) for rich structure</li>
                <li>Use prime moduli (17, 101) to see uniform distributions</li>
                <li>Enable animation recording before playback</li>
                <li>Experiment with different color schemes</li>
                <li>Use filters to isolate specific residue properties</li>
            </ol>

            <div class="divider">‚ÅÇ</div>

            <p class="no-indent" style="text-align: center; font-style: italic;">
                Exploring the intersection of number theory, geometry, and computation
            </p>
        </div>
    </div>

    <script>
        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Activate button
            event.target.classList.add('active');
            
            // If switching to portal and not initialized, initialize
            if (tabName === 'portal' && !window.portalInitialized) {
                setupEvents();
                calculate();
                render();
                window.portalInitialized = true;
            }
        }

        // Math utilities
        function gcd(a, b) { while (b) { [a, b] = [b, a % b]; } return a; }
        function phi(n) { let r = n, p = 2; while (p * p <= n) { if (n % p === 0) { while (n % p === 0) n /= p; r -= r / p; } p++; } if (n > 1) r -= r / n; return Math.round(r); }
        function isPrime(n) { if (n < 2) return false; if (n === 2) return true; if (n % 2 === 0) return false; for (let i = 3; i * i <= n; i += 2) if (n % i === 0) return false; return true; }
        function omega(n) { let c = 0, p = 2; while (p * p <= n) { if (n % p === 0) { c++; while (n % p === 0) n /= p; } p++; } if (n > 1) c++; return c; }
        function smallestPrimeFactor(n) { if (n <= 1) return 1; if (n % 2 === 0) return 2; for (let i = 3; i * i <= n; i += 2) if (n % i === 0) return i; return n; }
        function largestPrimeFactor(n) { let l = -1, t = n; while (t % 2 === 0) { l = 2; t /= 2; } for (let i = 3; i * i <= t; i += 2) { while (t % i === 0) { l = i; t /= i; } } if (t > 2) l = t; return l; }
        
        function primeFactorization(n) {
            const f = []; let d = 2;
            while (n > 1) {
                let c = 0;
                while (n % d === 0) { c++; n /= d; }
                if (c > 0) f.push({ p: d, e: c });
                d++; if (d * d > n && n > 1) { f.push({ p: n, e: 1 }); break; }
            }
            return f;
        }
        
        function formatFactorization(f) {
            const sup = '‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ';
            return f.map(x => x.e === 1 ? x.p : `${x.p}${x.e.toString().split('').map(d => sup[d]).join('')}`).join(' √ó ');
        }
        
        function getDivisors(n) {
            const d = new Set();
            for (let i = 1; i * i <= n; i++) if (n % i === 0) { d.add(i); d.add(n / i); }
            return Array.from(d).sort((a, b) => a - b);
        }

        function isPerfectSquare(n) {
            const sqrt = Math.floor(Math.sqrt(n));
            return sqrt * sqrt === n;
        }

        function isFibonacci(n) {
            return isPerfectSquare(5 * n * n + 4) || isPerfectSquare(5 * n * n - 4);
        }

        function isPowerOf2(n) {
            return n > 0 && (n & (n - 1)) === 0;
        }

        function isQuadraticResidue(a, p) {
            if (gcd(a, p) !== 1) return false;
            const exp = (p - 1) / 2;
            let result = 1, base = a % p, e = exp;
            while (e > 0) {
                if (e % 2 === 1) result = (result * base) % p;
                base = (base * base) % p;
                e = Math.floor(e / 2);
            }
            return result === 1;
        }

        function getPrimorial(n) {
            const primes = [];
            for (let i = 2; primes.length < n; i++) {
                if (isPrime(i)) primes.push(i);
            }
            return primes.reduce((a, b) => a * b, 1);
        }

        function factorial(n) {
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        const highlyCompositeNumbers = [1, 2, 4, 6, 12, 24, 36, 48, 60, 120, 180, 240, 360, 720, 840, 1260, 1680, 2520, 5040];

        function shouldShowPoint(p) {
            if (config.filterType === 'none') return true;
            if (config.filterType === 'prime') return isPrime(p.r);
            if (config.filterType === 'square') return isPerfectSquare(p.r);
            if (config.filterType === 'fibonacci') return isFibonacci(p.r);
            if (config.filterType === 'power2') return isPowerOf2(p.r);
            if (config.filterType === 'quadratic') return isQuadraticResidue(p.r, p.M);
            return true;
        }

        // State
        let config = {
            M: 42, zoom: 1, panX: 0, panY: 0, colorScheme: 'type', pointSize: 3,
            opacity: 1, spacingFactor: 1, minRing: 1, showProjections: true,
            showRings: true, showInnerRings: true, colorInner: false, gapHighlight: 'none',
            animSpeed: 500, loop: true, recording: false, rotation: 0, showSymmetry: false,
            highlightPrimes: false, filterType: 'none'
        };

        let points = [], channels = new Map(), innerRings = new Map();
        let gapPairs = { 2: [], 4: [], 6: [], 8: [], 10: [], 12: [] };
        let animInterval = null, recordedFrames = [];
        let isDragging = false, lastPos = { x: 0, y: 0 };
        let svgGroup, tooltip, vizContainer;

        // Color schemes
        const colors = {
            type: p => p.coprime ? '#00ffff' : '#ff1493',
            spf: p => p.coprime ? '#00ffff' : ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'][p.spf % 6],
            lpf: p => p.coprime ? '#00ffff' : ['#f00', '#0f0', '#00f', '#ff0', '#f0f'][p.lpf % 5],
            gcd: p => {
                const pct = p.gcd / config.M;
                const r = Math.round(130 + (255 - 130) * pct);
                const g = Math.round(80 + (20 - 80) * pct);
                const b = Math.round(223 + (147 - 223) * pct);
                return `rgb(${r},${g},${b})`;
            },
            depth: p => `hsl(${(p.channel / config.M) * 360}, 70%, 60%)`,
            rainbow: p => `hsl(${(p.r / p.M) * 360}, 70%, 60%)`
        };

        function getColor(p) {
            return colors[config.colorScheme](p);
        }

        // Calculate
        function calculate() {
            const M = config.M;
            points = [];
            channels.clear();
            innerRings.clear();
            Object.keys(gapPairs).forEach(k => gapPairs[k] = []);

            const coprimes = new Set();
            for (let r = 0; r < M; r++) {
                const g = gcd(r, M);
                const coprime = g === 1;
                const rr = r / g, rm = M / g;
                const angle = (2 * Math.PI * r) / M;  // Now 0¬∞ is at 3 o'clock (right side)
                
                if (coprime) coprimes.add(r);

                points.push({
                    r, M, gcd: g, coprime, rr, channel: rm, angle,
                    spf: smallestPrimeFactor(g === 1 ? M : g),
                    lpf: largestPrimeFactor(g === 1 ? M : g)
                });

                if (!channels.has(rm)) channels.set(rm, { M: rm, mult: M / rm, pts: [], count: 0 });
                channels.get(rm).pts.push(r);
                channels.get(rm).count++;
            }

            getDivisors(M).forEach(d => {
                if (d < config.minRing) return;
                const rpts = [];
                for (let r = 0; r < d; r++) {
                    const g = gcd(r, d);
                    rpts.push({
                        r, M: d, gcd: g, coprime: g === 1, channel: d / g,
                        angle: (2 * Math.PI * r) / d,  // Consistent angle mapping
                        spf: smallestPrimeFactor(g === 1 ? d : g),
                        lpf: largestPrimeFactor(g === 1 ? d : g)
                    });
                }
                innerRings.set(d, rpts);
            });

            for (let gap = 2; gap <= 12; gap += 2) {
                const seen = new Set();
                for (let r = 0; r < M; r++) {
                    const r2 = (r + gap) % M;
                    if (coprimes.has(r) && coprimes.has(r2)) {
                        const key = [r, r2].sort((a, b) => a - b).join('-');
                        if (!seen.has(key)) { seen.add(key); gapPairs[gap].push([r, r2]); }
                    }
                }
            }

            updateStats();
        }

        function updateStats() {
            const M = config.M;
            const f = primeFactorization(M);
            const p = phi(M);
            const coprime = points.filter(x => x.coprime).length;
            const prime = isPrime(M);
            const w = omega(M);

            document.getElementById('vizTitle').textContent = `Modular Space: M = ${M}`;
            document.getElementById('vizMeta').textContent = `Prime Factorization: ${formatFactorization(f)}`;
            document.getElementById('modVal').textContent = M;
            document.getElementById('modInput').value = M;
            document.getElementById('statM').textContent = M;
            document.getElementById('statPhi').textContent = p;
            document.getElementById('statCoprime').textContent = coprime;
            document.getElementById('statNonCoprime').textContent = M - coprime;
            document.getElementById('statChannels').textContent = channels.size;
            document.getElementById('statDensity').textContent = (p / M * 100).toFixed(1) + '%';
            document.getElementById('statClass').textContent = prime ? 'Prime' : 'Composite';
            
            const badge = document.getElementById('statBadge');
            badge.textContent = prime ? 'Prime' : `œâ(M)=${w}`;
            badge.className = prime ? 'badge badge-prime' : 'badge badge-composite';
            
            document.getElementById('statTwin').textContent = gapPairs[2].length;
            document.getElementById('statCousin').textContent = gapPairs[4].length;
            document.getElementById('statSexy').textContent = gapPairs[6].length;
            document.getElementById('statGap8').textContent = gapPairs[8].length;
        }

        // Render
        function render() {
            if (!svgGroup) return;
            
            svgGroup.innerHTML = '';
            const baseR = 400;

            // Apply rotation
            if (config.rotation !== 0) {
                svgGroup.setAttribute('transform', `rotate(${config.rotation})`);
            } else {
                svgGroup.removeAttribute('transform');
            }

            // Symmetry axes
            if (config.showSymmetry) {
                const numAxes = omega(config.M) > 0 ? Math.min(phi(config.M), 12) : 8;
                for (let i = 0; i < numAxes; i++) {
                    const angle = (Math.PI * 2 * i) / numAxes;
                    const x = baseR * 1.1 * Math.cos(angle);
                    const y = baseR * 1.1 * Math.sin(angle);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 0);
                    line.setAttribute('y1', 0);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', y);
                    line.setAttribute('stroke', '#444444');
                    line.setAttribute('stroke-width', '0.5');
                    line.setAttribute('opacity', '0.3');
                    line.setAttribute('stroke-dasharray', '5,5');
                    svgGroup.appendChild(line);
                }
            }

            // Gap highlights
            if (config.gapHighlight !== 'none') {
                const gap = parseInt(config.gapHighlight);
                const pairs = gapPairs[gap] || [];
                pairs.forEach(([r1, r2]) => {
                    const p1 = points[r1], p2 = points[r2];
                    if (!shouldShowPoint(p1) || !shouldShowPoint(p2)) return;
                    const x1 = baseR * Math.cos(p1.angle);
                    const y1 = baseR * Math.sin(p1.angle);
                    const x2 = baseR * Math.cos(p2.angle);
                    const y2 = baseR * Math.sin(p2.angle);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', '#ffcc00');
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('opacity', '0.6');
                    svgGroup.appendChild(line);
                });
            }

            // Projection lines
            if (config.showProjections) {
                points.forEach(p => {
                    if (!p.coprime && shouldShowPoint(p)) {
                        const ox = baseR * Math.cos(p.angle);
                        const oy = baseR * Math.sin(p.angle);
                        const cr = baseR * Math.pow(p.channel / config.M, config.spacingFactor);
                        const ta = (2 * Math.PI * p.rr) / p.channel;
                        const ix = cr * Math.cos(ta);
                        const iy = cr * Math.sin(ta);
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', ox);
                        line.setAttribute('y1', oy);
                        line.setAttribute('x2', ix);
                        line.setAttribute('y2', iy);
                        line.setAttribute('stroke', '#ff1493');
                        line.setAttribute('stroke-width', '0.5');
                        line.setAttribute('opacity', config.opacity);
                        svgGroup.appendChild(line);
                    }
                });
            }

            // Rings
            if (config.showRings) {
                getDivisors(config.M).filter(d => channels.has(d) && d >= config.minRing).forEach(d => {
                    const r = baseR * Math.pow(d / config.M, config.spacingFactor);
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', 0);
                    circle.setAttribute('cy', 0);
                    circle.setAttribute('r', r);
                    circle.setAttribute('fill', 'none');
                    circle.setAttribute('stroke', '#ffd700');
                    circle.setAttribute('stroke-width', '1');
                    svgGroup.appendChild(circle);
                });
            }

            // Inner points
            if (config.showInnerRings) {
                getDivisors(config.M).forEach(d => {
                    if (d === config.M || d < config.minRing) return;
                    const rpts = innerRings.get(d);
                    if (!rpts) return;
                    const r = baseR * Math.pow(d / config.M, config.spacingFactor);
                    rpts.forEach(p => {
                        if (!p.coprime && !config.colorInner) return;
                        if (!shouldShowPoint(p)) return;
                        const x = r * Math.cos(p.angle);
                        const y = r * Math.sin(p.angle);
                        const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        c.setAttribute('cx', x);
                        c.setAttribute('cy', y);
                        c.setAttribute('r', config.pointSize * 0.7);
                        c.setAttribute('fill', config.colorInner ? getColor(p) : '#ffd700');
                        svgGroup.appendChild(c);
                    });
                });
            }

            // Outer points
            points.forEach(p => {
                if (!shouldShowPoint(p)) return;
                const x = baseR * Math.cos(p.angle);
                const y = baseR * Math.sin(p.angle);
                const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                c.setAttribute('cx', x);
                c.setAttribute('cy', y);
                c.setAttribute('r', config.pointSize);
                
                // Highlight primes
                let color = getColor(p);
                if (config.highlightPrimes && isPrime(p.r) && p.coprime) {
                    color = '#ffff00';
                    c.setAttribute('r', config.pointSize * 1.3);
                }
                
                c.setAttribute('fill', color);
                c.setAttribute('data-r', p.r);
                c.style.cursor = 'pointer';
                svgGroup.appendChild(c);
            });
        }

        // Animation
        function startAnimation() {
            if (animInterval) return;
            animInterval = setInterval(() => {
                let next = config.M + 1;
                if (next > 5000) next = config.loop ? 2 : (stopAnimation(), config.M);
                setM(next);
                if (config.recording) recordedFrames.push({ M: config.M, svg: svgGroup.innerHTML });
            }, config.animSpeed);
            document.getElementById('playBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            if (config.recording) document.getElementById('recordingBadge').classList.add('active');
        }

        function stopAnimation() {
            if (!animInterval) return;
            clearInterval(animInterval);
            animInterval = null;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recordingBadge').classList.remove('active');
        }

        function resetView() {
            config.zoom = 1;
            config.panX = 0;
            config.panY = 0;
            document.getElementById('zoomSlider').value = 100;
            document.getElementById('zoomVal').textContent = '1.00';
            updateViewBox();
        }

        function updateViewBox() {
            const svg = document.getElementById('vizSVG');
            const s = 500 / config.zoom;
            svg.setAttribute('viewBox', `${-s + config.panX} ${-s + config.panY} ${s * 2} ${s * 2}`);
        }

        function setM(m) {
            config.M = m;
            document.getElementById('modSlider').value = Math.min(m, 5000);
            calculate();
            render();
        }

        // Analysis Functions (condensed for space)
        function analyzePattern() {
            const M = config.M;
            const phiM = phi(M);
            let report = `<h4 style="color: #667eea; margin-bottom: 0.5rem;">Pattern Analysis for M = ${M}</h4>`;
            report += `<p><strong>œÜ(M):</strong> ${phiM}</p>`;
            report += `<p><strong>Density:</strong> ${(phiM/M*100).toFixed(2)}%</p>`;
            report += `<p><strong>Channels:</strong> ${channels.size}</p>`;
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function compareModuli() {
            const current = config.M;
            const candidates = [current - 1, current + 1, current * 2, Math.floor(current / 2)].filter(m => m >= 2 && m <= 10000);
            let report = `<h4 style="color: #667eea;">Comparative Analysis</h4><table style="width:100%; font-size:0.85em;"><tr style="background:#667eea;color:white;"><th>M</th><th>œÜ(M)</th></tr>`;
            candidates.forEach(m => {
                const p = phi(m);
                report += `<tr style="${m===current?'background:#ffffcc;':''}cursor:pointer;" onclick="setM(${m})"><td>${m}</td><td>${p}</td></tr>`;
            });
            report += `</table>`;
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function findInteresting() {
            const interesting = [{m:30,r:"Primorial(3)"},{m:210,r:"Primorial(4)"},{m:1024,r:"2¬π‚Å∞"}];
            let report = `<h4 style="color:#667eea;">Interesting Moduli</h4>`;
            interesting.forEach(({m,r}) => {
                report += `<div style="padding:0.4rem;margin:0.3rem 0;background:#f8f9fa;border-left:3px solid #667eea;cursor:pointer;" onclick="setM(${m})"><strong>M=${m}</strong><br><span style="font-size:0.85em;color:#666;">${r}</span></div>`;
            });
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function showTheorems() {
            let report = `<h4 style="color:#667eea;">Mathematical Theorems</h4>`;
            report += `<p style="margin:0.5rem 0;"><strong>Euler's Theorem:</strong> If gcd(a,M)=1, then a<sup>œÜ(M)</sup> ‚â° 1 (mod M)</p>`;
            report += `<p style="margin:0.5rem 0;"><strong>Chinese Remainder:</strong> ‚Ñ§/(m‚ÇÅm‚ÇÇ)‚Ñ§ ‚âÖ ‚Ñ§/m‚ÇÅ‚Ñ§ √ó ‚Ñ§/m‚ÇÇ‚Ñ§</p>`;
            document.getElementById('analysisResults').innerHTML = report;
            document.getElementById('analysisResults').style.display = 'block';
        }

        function generatePrimorial() {
            const n = parseInt(prompt("Generate primorial(n) - enter n (1-8):", "4"));
            if (n && n >= 1 && n <= 8) setM(getPrimorial(n));
        }

        function generateFactorial() {
            const n = parseInt(prompt("Generate n! - enter n (2-7):", "5"));
            if (n && n >= 2 && n <= 7) setM(factorial(n));
        }

        function generateHighlyComposite() {
            const idx = parseInt(prompt(`Choose index (0-${highlyCompositeNumbers.length-1}):`, "10"));
            if (idx >= 0 && idx < highlyCompositeNumbers.length) setM(highlyCompositeNumbers[idx]);
        }

        function exportPNG() {
            const res = parseInt(document.getElementById('exportRes').value);
            const titleHeight = res * 0.08;
            const vizWidth = res * 0.70;
            const legendWidth = res * 0.30;
            const vizHeight = res - titleHeight;
            
            const canvas = document.createElement('canvas');
            canvas.width = res;
            canvas.height = res;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, res, res);
            
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, res, titleHeight);
            
            ctx.font = `bold ${titleHeight * 0.35}px Arial`;
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Modular Reduction Projection', res / 2, titleHeight * 0.35);
            
            ctx.font = `bold ${titleHeight * 0.30}px Arial`;
            ctx.fillStyle = '#ffd700';
            ctx.fillText(`M = ${config.M}`, res / 2, titleHeight * 0.75);
            
            const factors = primeFactorization(config.M);
            ctx.font = `${titleHeight * 0.18}px Arial`;
            ctx.fillStyle = '#aaaaaa';
            ctx.fillText(formatFactorization(factors), res / 2, titleHeight * 0.95);
            
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, titleHeight);
            ctx.lineTo(res, titleHeight);
            ctx.stroke();
            
            const vizCanvas = document.createElement('canvas');
            vizCanvas.width = vizWidth;
            vizCanvas.height = vizHeight;
            const vizCtx = vizCanvas.getContext('2d');
            
            vizCtx.fillStyle = '#000000';
            vizCtx.fillRect(0, 0, vizWidth, vizHeight);
            
            const svgData = new XMLSerializer().serializeToString(document.getElementById('vizSVG'));
            const img = new Image();
            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            img.onload = () => {
                const vizSize = Math.min(vizWidth, vizHeight);
                const offsetX = (vizWidth - vizSize) / 2;
                const offsetY = (vizHeight - vizSize) / 2;
                vizCtx.drawImage(img, offsetX, offsetY, vizSize, vizSize);
                URL.revokeObjectURL(url);
                
                ctx.drawImage(vizCanvas, 0, titleHeight);
                
                const lx = vizWidth;
                const ly = titleHeight;
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(lx, ly, legendWidth, vizHeight);
                
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 2;
                ctx.strokeRect(lx, ly, legendWidth, vizHeight);
                
                let yPos = ly + res * 0.03;
                const leftMargin = lx + res * 0.015;
                const fontSize = res * 0.011;
                const lineHeight = res * 0.018;
                
                ctx.textAlign = 'left';
                ctx.font = `bold ${fontSize * 1.3}px Arial`;
                ctx.fillStyle = '#ffd700';
                ctx.fillText('Statistical Analysis', leftMargin, yPos);
                yPos += lineHeight * 2;
                
                const M = config.M;
                const phiM = phi(M);
                
                ctx.font = `bold ${fontSize * 1.05}px Arial`;
                ctx.fillStyle = '#00ffff';
                ctx.fillText('Modulus Properties', leftMargin, yPos);
                yPos += lineHeight * 1.2;
                
                ctx.font = `${fontSize * 0.88}px Arial`;
                ctx.fillStyle = '#cccccc';
                
                const modProps = [`M = ${M}`, `œÜ(M) = ${phiM}`, `Channels = ${channels.size}`];
                modProps.forEach(prop => {
                    ctx.fillText(prop, leftMargin + fontSize * 0.4, yPos);
                    yPos += lineHeight * 0.9;
                });
                
                canvas.toBlob(blob => {
                    const a = document.createElement('a');
                    a.download = `modular-M${config.M}-${res}px.png`;
                    a.href = URL.createObjectURL(blob);
                    a.click();
                });
            };
            img.src = url;
        }

        function exportCSV() {
            let csv = `Residue,Modulus,GCD,Status,Channel\n`;
            points.forEach(p => csv += `${p.r},${p.M},${p.gcd},${p.coprime?'Coprime':'Non-coprime'},${p.channel}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.download = `modular-M${config.M}.csv`;
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        function exportJSON() {
            const data = {
                M: config.M,
                phi: phi(config.M),
                points: points.map(p => ({ r: p.r, gcd: p.gcd, coprime: p.coprime, channel: p.channel }))
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.download = `modular-M${config.M}.json`;
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        function exportFrames() {
            if (recordedFrames.length === 0) return alert('No frames recorded');
            alert(`Exporting ${recordedFrames.length} frames...`);
            recordedFrames.forEach((frame, i) => {
                setTimeout(() => {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = 2000;
                    tempCanvas.height = 2000;
                    const ctx = tempCanvas.getContext('2d');
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, 2000, 2000);
                    const svgStr = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-500 -500 1000 1000" width="2000" height="2000"><rect x="-500" y="-500" width="1000" height="1000" fill="#000"/>${frame.svg}</svg>`;
                    const img = new Image();
                    const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, 2000, 2000);
                        URL.revokeObjectURL(url);
                        tempCanvas.toBlob(b => {
                            const a = document.createElement('a');
                            a.download = `frame_${String(i).padStart(4,'0')}_M${frame.M}.png`;
                            a.href = URL.createObjectURL(b);
                            a.click();
                        });
                    };
                    img.src = url;
                }, i * 100);
            });
        }

        function exportGIF() {
            if (recordedFrames.length === 0) return alert('No frames recorded');
            alert(`Creating GIF from ${recordedFrames.length} frames...`);
            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: 800,
                height: 800,
                workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
            });
            let processed = 0;
            recordedFrames.forEach((frame, i) => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 800;
                tempCanvas.height = 800;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 800, 800);
                const svgStr = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="-500 -500 1000 1000" width="800" height="800"><rect x="-500" y="-500" width="1000" height="1000" fill="#000"/>${frame.svg}</svg>`;
                const img = new Image();
                const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, 800, 800);
                    URL.revokeObjectURL(url);
                    ctx.font = 'bold 20px Arial';
                    ctx.fillStyle = '#fff';
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 3;
                    ctx.strokeText(`M = ${frame.M}`, 15, 30);
                    ctx.fillText(`M = ${frame.M}`, 15, 30);
                    gif.addFrame(tempCanvas, { delay: config.animSpeed, copy: true });
                    processed++;
                    if (processed === recordedFrames.length) {
                        gif.on('finished', b => {
                            const a = document.createElement('a');
                            a.download = `modular-animation-${recordedFrames.length}frames.gif`;
                            a.href = URL.createObjectURL(b);
                            a.click();
                            alert('GIF created!');
                        });
                        gif.render();
                    }
                };
                img.src = url;
            });
        }

        function exportLaTeX() {
            const M = config.M;
            const factors = primeFactorization(M);
            const phiM = phi(M);
            let latex = `\\documentclass{article}\n\\usepackage{amsmath}\n\\begin{document}\n\\section*{Modular Reduction: $M = ${M}$}\n$$M = ${factors.map(f => f.e===1?`${f.p}`:`${f.p}^{${f.e}}`).join(' \\cdot ')}$$\n$$\\varphi(${M}) = ${phiM}$$\n\\end{document}`;
            const blob = new Blob([latex], { type: 'text/plain' });
            const a = document.createElement('a');
            a.download = `modular-M${M}.tex`;
            a.href = URL.createObjectURL(blob);
            a.click();
        }

        // Events
        function setupEvents() {
            svgGroup = document.getElementById('vizGroup');
            tooltip = document.getElementById('tooltip');
            vizContainer = document.getElementById('vizContainer');

            let startDist = 0;
            vizContainer.addEventListener('mousedown', e => {
                isDragging = true;
                lastPos = { x: e.clientX, y: e.clientY };
            });
            vizContainer.addEventListener('mousemove', e => {
                if (isDragging) {
                    const dx = e.clientX - lastPos.x;
                    const dy = e.clientY - lastPos.y;
                    config.panX -= dx / config.zoom;
                    config.panY -= dy / config.zoom;
                    lastPos = { x: e.clientX, y: e.clientY };
                    updateViewBox();
                }
                
                const target = e.target;
                if (target.hasAttribute('data-r')) {
                    const r = parseInt(target.getAttribute('data-r'));
                    const p = points[r];
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.pageX + 15) + 'px';
                    tooltip.style.top = (e.pageY + 15) + 'px';
                    tooltip.innerHTML = `<strong>r = ${p.r}</strong><br>M = ${p.M}<br>GCD = ${p.gcd}<br>${p.coprime ? 'Coprime' : `Channel M' = ${p.channel}`}<br>Angle: ${((p.angle * 180 / Math.PI) % 360).toFixed(1)}¬∞`;
                } else {
                    tooltip.style.display = 'none';
                }
            });
            vizContainer.addEventListener('mouseup', () => isDragging = false);
            vizContainer.addEventListener('mouseleave', () => {
                isDragging = false;
                tooltip.style.display = 'none';
            });

            vizContainer.addEventListener('wheel', e => {
                e.preventDefault();
                const delta = e.deltaY < 0 ? 1.1 : 0.9;
                config.zoom = Math.min(Math.max(config.zoom * delta, 0.1), 5);
                document.getElementById('zoomSlider').value = Math.round(config.zoom * 100);
                document.getElementById('zoomVal').textContent = config.zoom.toFixed(2);
                updateViewBox();
            }, { passive: false });

            vizContainer.addEventListener('touchstart', e => {
                if (e.touches.length === 2) {
                    const t1 = e.touches[0], t2 = e.touches[1];
                    startDist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
                } else if (e.touches.length === 1) {
                    isDragging = true;
                    lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });

            vizContainer.addEventListener('touchmove', e => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    const t1 = e.touches[0], t2 = e.touches[1];
                    const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
                    const delta = dist / startDist;
                    config.zoom = Math.min(Math.max(config.zoom * delta, 0.1), 5);
                    startDist = dist;
                    document.getElementById('zoomSlider').value = Math.round(config.zoom * 100);
                    document.getElementById('zoomVal').textContent = config.zoom.toFixed(2);
                    updateViewBox();
                } else if (e.touches.length === 1 && isDragging) {
                    const dx = e.touches[0].clientX - lastPos.x;
                    const dy = e.touches[0].clientY - lastPos.y;
                    config.panX -= dx / config.zoom;
                    config.panY -= dy / config.zoom;
                    lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    updateViewBox();
                }
            }, { passive: false });

            vizContainer.addEventListener('touchend', () => {
                isDragging = false;
                startDist = 0;
            });

            document.getElementById('modSlider').oninput = e => setM(parseInt(e.target.value));
            document.getElementById('modInput').oninput = e => {
                const v = parseInt(e.target.value);
                if (v >= 2 && v <= 10000) setM(v);
            };
            document.getElementById('zoomSlider').oninput = e => {
                config.zoom = parseInt(e.target.value) / 100;
                document.getElementById('zoomVal').textContent = config.zoom.toFixed(2);
                updateViewBox();
            };
            document.getElementById('speedSlider').oninput = e => {
                config.animSpeed = parseInt(e.target.value);
                document.getElementById('speedVal').textContent = e.target.value;
            };
            document.getElementById('pointSizeSlider').oninput = e => {
                config.pointSize = parseFloat(e.target.value);
                document.getElementById('pointSizeVal').textContent = config.pointSize.toFixed(1);
                render();
            };
            document.getElementById('opacitySlider').oninput = e => {
                config.opacity = parseInt(e.target.value) / 100;
                document.getElementById('opacityVal').textContent = e.target.value;
                render();
            };
            document.getElementById('spacingSlider').oninput = e => {
                config.spacingFactor = parseInt(e.target.value) / 100;
                document.getElementById('spacingVal').textContent = config.spacingFactor.toFixed(2);
                calculate();
                render();
            };
            document.getElementById('minRingSlider').oninput = e => {
                config.minRing = parseInt(e.target.value);
                document.getElementById('minRingVal').textContent = e.target.value;
                calculate();
                render();
            };
            document.getElementById('rotationSlider').oninput = e => {
                config.rotation = parseInt(e.target.value);
                document.getElementById('rotationVal').textContent = e.target.value;
                render();
            };
            document.getElementById('colorScheme').onchange = e => {
                config.colorScheme = e.target.value;
                render();
            };
            document.getElementById('gapSelect').onchange = e => {
                config.gapHighlight = e.target.value;
                render();
            };
            document.getElementById('filterType').onchange = e => {
                config.filterType = e.target.value;
                render();
            };
            document.getElementById('showProjections').onchange = e => {
                config.showProjections = e.target.checked;
                render();
            };
            document.getElementById('showRings').onchange = e => {
                config.showRings = e.target.checked;
                render();
            };
            document.getElementById('showInnerRings').onchange = e => {
                config.showInnerRings = e.target.checked;
                render();
            };
            document.getElementById('colorInner').onchange = e => {
                config.colorInner = e.target.checked;
                render();
            };
            document.getElementById('showSymmetry').onchange = e => {
                config.showSymmetry = e.target.checked;
                render();
            };
            document.getElementById('highlightPrimes').onchange = e => {
                config.highlightPrimes = e.target.checked;
                render();
            };
            document.getElementById('loopCheck').onchange = e => {
                config.loop = e.target.checked;
            };
            document.getElementById('recordCheck').onchange = e => {
                config.recording = e.target.checked;
                if (config.recording) recordedFrames = [];
            };
        }

        // Initialize when portal tab is first opened
        window.portalInitialized = false;
    </script>
</body>
</html>
